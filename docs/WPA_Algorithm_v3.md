# WPA Algorithm v3.3 Specification

## 1. 核心理念 (Core Concepts)

WPA (Win Probability Added) 用于量化玩家在 CS2 比赛中每一个动作（击杀、下包、存活等）对团队获胜概率的**净贡献值**。

v3.3 版本是为了解决 v3.0 线性模型在复杂局势下的失真问题（如 1v5 下包奖励过高、做默认控图被扣分等）。

### 1.1 零和原则 (Zero-Sum Symmetry)
$$ \sum WPA_{all\_players} \approx 0 $$
*   **对称分配**: 若事件导致 T 胜率 $+\Delta P$，则：
    *   T 方相关玩家（如击杀者）获得正分。
    *   CT 方相关玩家（如被击杀者）分摊负分。

---

## 2. 初始胜率与经济修正 (Initial Probability & Economy)

在回合冻结时间结束 ($t=0$) 且无人员伤亡时，胜率不再默认为 50/50，而是由**双方装备价值差异**决定。

### 2.1 经济权重逻辑
长枪局打 Eco 局，优势方理应获胜。如果获胜，WPA 奖励应较少；如果输掉，扣分应极多。

$$ P_{initial} = 0.50 + \beta \times \ln(1 + \frac{Value_{T} - Value_{CT}}{C_{eco}}) $$

*   **$Value_{T/CT}$**: 队伍当前的装备总价值（主武器+护甲+道具）。
*   **$C_{eco}$**: 经济差归一化常数（如 $5000）。
*   **$\beta$**: 权重系数（约 0.15）。
*   **边界**: $P_{initial}$ 限制在 $[0.20, 0.80]$ 之间，避免开局即判负。

---

## 3. 双矩阵预测系统 (Dual Matrix System)

v3.3 废弃了单一的“人数对比表”，引入基于 C4 状态的**双矩阵**。这是解决“下包奖励”问题的核心。

### 3.1 Pre-Plant Matrix (未下包矩阵)
*   **适用场景**: 回合开始 ~ C4 安放前。
*   **核心逻辑**: CT 防守优势。时间耗尽 CT 胜。随着 T 人数减少，胜率指数级下跌。
*   **数值示例 (T vs CT)**:
    *   5v5: ~50% (受经济修正)
    *   3v5: ~20%
    *   1v5: ~1% (绝望)

### 3.2 Post-Plant Matrix (已下包矩阵)
*   **适用场景**: C4 安放后 ~ 回合结束。
*   **核心逻辑**: T 防守优势（CT 需回防拆包）。C4 爆炸 T 胜。
*   **数值示例 (T vs CT)**:
    *   5v5: ~85% (CT 回防极难)
    *   3v3: ~70%
    *   1v5: ~3% (CT 可以在 T 只有 1 人时强拆)

### 3.3 下包 WPA 计算修正
下包事件的 WPA 不再是固定值，而是矩阵切换产生的差值：
$$ WPA_{plant} = P_{Post}(Alive_T, Alive_{CT}) - P_{Pre}(Alive_T, Alive_{CT}) $$

*   **5v5 下包**: $0.85 - 0.50 = +0.35$ (极大贡献，改变局势)。
*   **1v5 下包**: $0.03 - 0.01 = +0.02$ (微小贡献，仅视为经济收益)。

---

## 4. 动态修正因子 (Dynamic Modifiers)

$$ P_{final} = P_{matrix} + Mod_{Health} + Mod_{Time} $$

### 4.1 生命值修正 (Health Modifier)
引入双方总血量差值，作为人数优势的二级修正。
$$ Mod_{Health} = \alpha \times \frac{(HP_{T} - HP_{CT})}{500} $$
*   **系数 $\alpha$**: 设定为 **0.05** (极低权重)。
*   **逻辑**:
    *   即使 T 比 CT 多 200HP，胜率仅提升 2%。
    *   **伤害阈值**: 当某方受到伤害 $<40$ 时，视为无效消耗，不影响胜率（避免蹭血刷分）。
    *   **原则**: "1HP 也是战斗力"，人数永远大于血量。

### 4.2 非线性时间衰减 (Sigmoid Time Decay)
针对 Pre-Plant 阶段，时间对 T 胜率的影响改为分段非线性函数。

1.  **安全期 (1:55 - 0:30)**:
    *   **衰减**: 0 (或极微小)。
    *   **目的**: 允许 T 做默认控图（Default），不因时间流逝扣分。

2.  **施压期 (0:30 - 0:00)**:
    *   **衰减**: 基于三次函数加速下跌。
    *   **公式**: $P(t) = P_{base} \times (1 - (\frac{30 - t}{30})^3)$
    *   **效果**:
        *   剩 30s: 胜率 100% (相对于基准)。
        *   剩 15s: 胜率 87.5% (缓慢下降)。
        *   剩 5s: 胜率 50% (大幅下跌)。
        *   剩 0s: 胜率 0% (输掉)。

---

## 5. 事件处理流程 (Event Processing)

### A. 伤害事件 (Damage)
1.  更新 `HealthTracker`。
2.  计算 $Mod_{Health}$ 变化量。
3.  如果伤害导致 HP 差异显著，产生微量 WPA 变动。

### B. 击杀事件 (Kill)
1.  **确定状态**: Pre-Plant 或 Post-Plant。
2.  **更新人数**: 减少受害者方存活人数。
3.  **计算 $\Delta P$**: $P_{new} - P_{old}$。
4.  **分配 WPA**:
    *   击杀者: $+\Delta P \times (1 - AssistShare)$
    *   助攻者: $+\Delta P \times AssistShare$ (闪光助攻权重更高)
    *   受害者: $-\Delta P$ (完全承担责任)

### C. 炸弹事件 (Objective)
1.  **下包 (Plant)**:
    *   切换矩阵 $Pre \to Post$。
    *   下包者获得主要 WPA，队友获得少量战术协同分。
2.  **拆包 (Defuse)**:
    *   T 胜率直接归零。
    *   拆包者获得巨额 WPA（通常是翻盘分）。

### D. 回合结束 (Round End)
1.  **清算**: 比较最终 $P_{end}$ 与结果 (1.0 或 0.0)。
2.  **残差分配**: 将剩余的概率差值（通常很小）平均分配给获胜/失败方的所有存活队员，作为“存活/保枪”修正。

---

## 6. 参数配置 (Configuration)

| 参数 | 值 | 说明 |
| :--- | :--- | :--- |
| `MATRIX_PRE` | Table | 基于竞技大数据的胜率表 (T劣势) |
| `MATRIX_POST` | Table | 基于竞技大数据的胜率表 (T优势) |
| `COEFF_ECON` | 0.15 | 经济差对初始胜率的影响系数 |
| `COEFF_HP` | 0.05 | 血量差对胜率的影响系数 |
| `TIME_PANIC` | 30s | 时间开始加速衰减的阈值 |
| `ASSIST_WEIGHT` | 0.25 | 普通助攻分摊比例 |
| `FLASH_WEIGHT` | 0.35 | 闪光助攻分摊比例 |

