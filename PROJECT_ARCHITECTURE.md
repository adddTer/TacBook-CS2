# Project Architecture Documentation

> **Generated by System Architect**
> **Date**: 2026-02-18

This document provides a comprehensive overview of the TacBook CS2 codebase, detailing its architectural structure, core logic, and key business flows.

---

## 1. System Overview (å…¨å±€æ¶æ„æ¦‚è§ˆ)

The application is a **Client-Side React Application (SPA)** built with Vite and TypeScript. It serves as a tactical playbook and match review tool for CS2 teams, featuring offline-first data persistence and AI-powered analysis.

### Directory Structure & Responsibilities

- **`/components`**: Contains all React UI components.
  - **`/components/review`**: Specific components for the Match Review / Demo Analysis feature.
  - **`/components/ai`**: AI-related UI components (Chat, Config).
- **`/utils`**: Contains pure functions and core business logic.
  - **`/utils/rating3`**: The core Rating 4.0 / WPA (Win Probability Added) calculation engine.
  - **`/utils/analytics`**: Statistical aggregation and advanced metric calculations (Firepower, Entry, etc.).
  - **`/utils/demo`**: Helper functions for demo parsing and data normalization.
- **`/hooks`**: Custom React hooks for state management and logic encapsulation.
- **`/services`**: Interfaces for external services (primarily Google Gemini AI).
- **`/data`**: Static data files (Map tactics, utility lineups, weapon data).
- **`/types.ts`**: Global TypeScript type definitions.

---

## 2. Core Logic Manifest (æ ¸å¿ƒä»£ç è¯¦ç»†ç´¢å¼•)

### A. Core Algorithms & Data Processing (æ ¸å¿ƒç®—æ³•)

| File Path | Primary Responsibility | Key Exports | Dependencies |
| :--- | :--- | :--- | :--- |
| `utils/demoParser.ts` | **[CRITICAL]** Parses raw JSON demo data (from external tools) into the application's internal `Match` format. | `parseDemoJson` | `RatingEngine`, `HealthTracker`, `idGenerator` |
| `utils/rating3/RatingEngine.ts` | **[CRITICAL]** The main engine that processes round events to calculate player ratings (Rating 4.0). | `RatingEngine` | `WPAEngine`, `InventoryTracker`, `HealthTracker` |
| `utils/rating3/WPAEngine.ts` | Calculates Win Probability Added (WPA) based on game state (alive players, health, time, objective). | `WPAEngine` | `wpa/constants` |
| `utils/rating3/rating/formula.ts` | Implements the specific mathematical formula for Rating 4.0. | `calculateRoundRating` | `ratingTypes` |
| `utils/analytics/statsAggregator.ts` | Aggregates raw match data into a unified stats object for a player across multiple matches. | `aggregatePlayerStats` | `types`, `weaponHelper` |
| `utils/analytics/playerStatsCalculator.ts` | Calculates high-level ability scores (Firepower, Entry, etc.) from aggregated stats. | `calculatePlayerStats` | `statsAggregator`, `calculateFirepower`, etc. |
| `utils/exportPlayers.ts` | Handles the export of player data to JSON files. | `exportPlayersToJson` | `shareHelper` |

### B. State Management & Hooks (çŠ¶æ€ç®¡ç†)

| File Path | Primary Responsibility | Key Exports | Dependencies |
| :--- | :--- | :--- | :--- |
| `hooks/useAppStorage.ts` | **[CRITICAL]** Centralized storage manager. Handles persistence of Tactics, Utilities, Matches, and Groups to IndexedDB/LocalStorage. | `useAppStorage` | `db`, `idGenerator` |
| `hooks/usePlayerStats.ts` | React hook that wraps the stats calculation logic for UI consumption. | `usePlayerStats` | `playerStatsCalculator` |
| `hooks/useTactics.ts` | Manages filtering and retrieval of tactics based on map and side. | `useTactics` | `types` |

### C. AI Services (äººå·¥æ™ºèƒ½æœåŠ¡)

| File Path | Primary Responsibility | Key Exports | Dependencies |
| :--- | :--- | :--- | :--- |
| `services/ai/agents/playerReportAgent.ts` | Generates qualitative player analysis reports using GenAI. | `generatePlayerAnalysis` | `providers`, `playerReportPrompts` |
| `services/ai/providers.ts` | Low-level wrapper for the Google Gemini API. | `generateAIResponse` | `@google/genai` |

### D. Key UI Components (å…³é”®ç•Œé¢)

| File Path | Primary Responsibility | Key Exports | Dependencies |
| :--- | :--- | :--- | :--- |
| `App.tsx` | Root component. Manages global state (Theme, ViewMode) and layout. | `App` | `ReviewView`, `ArsenalView`, `TacticEditor` |
| `components/ReviewView.tsx` | Main container for the "Review" (å¤ç›˜) tab. Orchestrates Match List, Player List, and Imports. | `ReviewView` | `MatchList`, `PlayerList`, `demoParser` |
| `components/review/PlayerDetail.tsx` | Detailed view for a single player's stats, including the Hexagon chart and AI report. | `PlayerDetail` | `usePlayerStats`, `PlayerAiReportModal` |
| `components/review/MatchDetail.tsx` | Detailed view for a single match, showing scoreboard and round timeline. | `MatchDetail` | `ScoreboardTab`, `TimelineTab` |
| `components/TacticEditor.tsx` | Editor for creating and modifying tactics (Canvas drawing). | `TacticEditor` | `fabric.js` (implied) |

---

## 3. Key Business Logic Flows (å…³é”®ä¸šåŠ¡é€»è¾‘é“¾è·¯)

### 1. Demo Import & Parsing Flow (Demo è§£ææµç¨‹)
This flow converts raw game data into the app's structured format.
1.  **Input**: User uploads a `.json` file (exported from a CS2 demo parser).
2.  **`ReviewView.tsx`**: Handles file selection and reads file content.
3.  **`utils/demoParser.ts`**: `parseDemoJson()` is called.
    *   Iterates through raw events (kills, damage, bomb plants).
    *   **`utils/rating3/RatingEngine.ts`**: Processes events to calculate WPA and Rating 4.0 for each round.
    *   **`utils/rating3/WPAEngine.ts`**: Updates win probability based on game state changes.
4.  **Output**: A structured `Match` object is returned.
5.  **Storage**: `onSaveMatch` (from `useAppStorage`) saves the `Match` object to IndexedDB.

### 2. Player Statistics Calculation Flow (è¯„åˆ†è®¡ç®—æµç¨‹)
This flow generates the data shown on the Player Detail card.
1.  **Input**: A `profileId` and a list of `Match` history.
2.  **`hooks/usePlayerStats.ts`**: Calls the calculator.
3.  **`utils/analytics/playerStatsCalculator.ts`**:
    *   Calls **`statsAggregator.ts`** to sum up raw stats (kills, deaths, adr, etc.) from all matches.
    *   Calls specialized calculators (e.g., `calculateFirepower.ts`, `calculateEntry.ts`) to compute 0-100 ability scores.
4.  **Output**: A `StatsResult` object containing `overall` ratings, `filtered` stats, and `details` for the UI.

### 3. AI Report Generation Flow (AI æŠ¥å‘Šç”Ÿæˆæµç¨‹)
1.  **Input**: Player's calculated stats (`StatsResult`) and profile info.
2.  **`components/review/PlayerDetail.tsx`**: User clicks "Generate Report".
3.  **`services/ai/agents/playerReportAgent.ts`**:
    *   Pre-processes stats to remove anomalies.
    *   Constructs a prompt using `services/ai/playerReportPrompts.ts`.
    *   Calls `services/ai/providers.ts` to send request to Gemini.
4.  **Output**: A structured JSON/Markdown report.
5.  **Storage**: Saved to `localStorage` for caching.

### 4. Data Export Flow (æ•°æ®å¯¼å‡ºæµç¨‹)
1.  **Input**: User clicks "Export" in `ReviewView`.
2.  **`ReviewView.tsx`**:
    *   Iterates through all players.
    *   Calculates full stats for each player using `calculatePlayerStats`.
3.  **`utils/exportPlayers.ts`**:
    *   Packages data into a JSON blob.
    *   Attempts to use `navigator.share` (Mobile).
    *   Falls back to `downloadBlob` (Desktop) if sharing fails.
4.  **Output**: A `.json` file downloaded to the user's device.

---

## 4. Maintenance Notes (ç»´æŠ¤æ³¨æ„äº‹é¡¹)

### ğŸ”´ High Risk / Core Logic (æ ¸å¿ƒä¸­çš„æ ¸å¿ƒ)
*Modifying these files requires extreme caution as they affect data integrity across the entire app.*

*   **`utils/rating3/RatingEngine.ts`**: The "Brain" of the app. Changes here alter how every match is rated.
*   **`utils/demoParser.ts`**: If this breaks, no new matches can be imported.
*   **`utils/analytics/playerStatsCalculator.ts`**: Changes here affect all player ability scores.
*   **`types.ts`**: Global type definitions. Changing interfaces here usually requires refactoring multiple files.

### ğŸŸ¡ Medium Risk / Feature Logic
*   **`hooks/useAppStorage.ts`**: Data persistence logic. Critical for saving user data but less complex algorithmically.
*   **`services/ai/*`**: AI logic. Failures here usually only break the AI features, not the core app.

### ğŸŸ¢ Low Risk / UI Components
*   **`components/*`**: Visual changes. Most components are isolated.
*   **`data/*`**: Static data files. Safe to add new maps or tactics.

---
*End of Document*
